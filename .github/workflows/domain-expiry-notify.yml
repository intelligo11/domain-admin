name: Domain Expiry Notification

# å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ 9:00 æ‰§è¡Œ
on:
  # schedule:
  #   - cron: '0 1 * * *'  # UTC 1:00 = åŒ—äº¬æ—¶é—´ 9:00
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Configuration
        run: |
          if [ -z "${{ secrets.PAGES_URL }}" ]; then
            echo "âŒ é”™è¯¯ï¼šPAGES_URL Secret æœªé…ç½®ï¼"
            echo "è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ  PAGES_URL Secret"
            echo "è·¯å¾„ï¼šSettings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          echo "âœ… PAGES_URL å·²é…ç½®"
          
      - name: Send Domain Expiry Notification
        run: |
          # ğŸ”’ ä½¿ç”¨ API Token è®¤è¯ä¿æŠ¤æ¥å£
          echo "ğŸš€ å¼€å§‹æ‰§è¡ŒåŸŸååˆ°æœŸé€šçŸ¥ä»»åŠ¡..."
          
          # æ„å»ºå¸¦ Token çš„ API URL
          API_URL="${{ secrets.PAGES_URL }}/api/cron/notify"
          if [ -n "${{ secrets.CRON_API_KEY }}" ]; then
            API_URL="${API_URL}?token=${{ secrets.CRON_API_KEY }}"
          fi
          
          response=$(curl -s -w "\n%{http_code}" -X GET "$API_URL")
          http_code=$(echo "$response" | tail -n1)
          
          echo "ğŸ“Š HTTP Status: $http_code"
          
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ é€šçŸ¥å‘é€å¤±è´¥ (HTTP $http_code)"
            echo "ğŸ’¡ æç¤ºï¼šè¯·æ£€æŸ¥ Cloudflare Pages éƒ¨ç½²çŠ¶æ€å’Œ CRON_API_KEY é…ç½®"
            exit 1
          else
            echo "âœ… é€šçŸ¥å‘é€æˆåŠŸ"
          fi
